name: Deploy to Agent Engine

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: "3.11"
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: "us-central1"
  AGENT_NAME: "seichijunrei-bot"

jobs:
  deploy:
    name: Deploy to Agent Engine
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Install ADK CLI
        run: pip install google-adk

      - name: Deploy to Agent Engine
        run: |
          # Debug: show current directory and structure
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo ""
          echo "ADK agents directory:"
          ls -la adk_agents/

          # Deploy the adk_agents directory (same as local: adk web adk_agents)
          adk deploy agent_engine \
            --project=${{ env.GCP_PROJECT_ID }} \
            --region=${{ env.GCP_REGION }} \
            --staging_bucket=gs://${{ env.GCP_PROJECT_ID }}-agent-staging \
            --display_name="${{ env.AGENT_NAME }}-${{ github.event.inputs.environment || 'staging' }}" \
            adk_agents
        continue-on-error: false

      - name: Get deployment info
        if: success()
        run: |
          echo "Deployment completed successfully!"
          echo "Agent Name: ${{ env.AGENT_NAME }}"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "Region: ${{ env.GCP_REGION }}"

      - name: Run smoke tests
        if: success()
        run: |
          echo "Running smoke tests..."
          uv run python -c "
          import asyncio
          from health import health_check
          result = asyncio.run(health_check())
          print(f'Health check: {result}')
          assert result['status'] == 'healthy'
          "
        continue-on-error: true

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Notify on success
        if: needs.deploy.result == 'success'
        run: |
          echo "✅ Deployment successful!"
          echo "Agent Engine deployment completed for ${{ env.AGENT_NAME }}"

      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "❌ Deployment failed!"
          echo "Please check the workflow logs for details."
